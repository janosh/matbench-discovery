"""Concatenate MACE results from multiple data files generated by slurm job array
into single file.
"""


# %%
from __future__ import annotations

import os

import pandas as pd
from pymatviz import density_scatter
from tqdm import tqdm

from matbench_discovery.data import as_dict_handler, df_wbm
from matbench_discovery.energy import (
    apply_mp_2020_corrections_to_ml_struct,
    get_e_form_per_atom,
)
from matbench_discovery.preds import e_form_col
from matbench_discovery.slurm import join_slurm_job_array_results

__author__ = "Janosh Riebesell"
__date__ = "2023-03-01"


# %%
module_dir = os.path.dirname(__file__)
task_type = "IS2RE"
date = "2023-09-26"
glob_pattern = f"{module_dir}/{date}-mace-wbm-{task_type}*/*.json.gz"
struct_col = "mace_structure"
id_col = "material_id"
e_form_mace_col = "e_form_per_atom_mace"
entry_col = "computed_structure_entry"


# %%
def post_process(df: pd.DataFrame) -> pd.DataFrame:
    """Apply MP 2020 energy corrections and compute corrected formation energy."""
    df = apply_mp_2020_corrections_to_ml_struct(
        df, energy_col="mace_energy", struct_col=struct_col, entry_col=entry_col
    )
    df["formula"] = df_wbm.formula
    df[e_form_mace_col] = [
        # cse.energy includes MP 2020 corrections
        get_e_form_per_atom(dict(energy=cse.energy, composition=formula))
        for formula, cse in tqdm(
            df.set_index("formula")[entry_col].items(), total=len(df)
        )
    ]
    return df


df_mace, out_path = join_slurm_job_array_results(
    glob_pattern=glob_pattern, drop_cols="mace_trajectory", post_process=post_process
)


# %%
df_wbm[e_form_mace_col] = df_mace[e_form_mace_col]
bad_mask = (df_wbm[e_form_col] - df_wbm[e_form_mace_col]).abs() > 10
print(f"{sum(bad_mask)=}")
ax = density_scatter(df=df_wbm[~bad_mask], x=e_form_col, y=e_form_mace_col)


# %%
df_mace[~bad_mask].select_dtypes("number").to_csv(f"{out_path}.csv.gz")
df_mace.reset_index().to_json(f"{out_path}.json.gz", default_handler=as_dict_handler)

df_bad = df_mace[bad_mask].drop(columns=[entry_col, struct_col])
df_bad[e_form_col] = df_wbm[e_form_col]
df_bad.to_csv(f"{out_path}-bad.csv")

# in_path = f"{module_dir}/2023-08-14-mace-wbm-IS2RE-FIRE"
# df_mace = pd.read_csv(f"{in_path}.csv.gz").set_index(id_col)
# df_mace = pd.read_json(f"{in_path}.json.gz").set_index(id_col)
